# 智能客服系统测试指南

## 概述

本文档描述了智能客服系统的完整测试体系，包括测试策略、测试用例、测试工具和测试运行方法，确保系统的稳定性和可靠性。

## 测试架构

### 测试分层
```
测试体系
├── 单元测试 (Unit Tests)
│   ├── API端点测试
│   ├── 业务逻辑测试
│   └── 工具函数测试
├── 前端测试 (Frontend Tests)
│   ├── 组件功能测试
│   ├── 用户界面测试
│   └── 交互流程测试
├── 集成测试 (Integration Tests)
│   ├── 端到端业务流程
│   ├── 系统集成测试
│   └── 数据一致性测试
└── 性能测试 (Performance Tests)
    ├── 负载测试
    ├── 压力测试
    └── 基准测试
```

### 测试文件结构
```
tests/
├── conftest.py              # pytest 配置和共享 fixtures
├── test_api.py             # API 单元测试
├── test_frontend.py        # 前端组件测试
├── test_integration.py     # 集成测试
├── test_utils.py           # 测试工具和辅助函数
├── test_config.py          # 测试配置和常量
├── run_tests.py            # Python 测试运行脚本
├── run_tests.bat           # Windows 批处理脚本
├── run_tests.ps1           # PowerShell 脚本
├── pytest.ini             # pytest 配置文件
├── README.md               # 测试文档
└── reports/                 # 测试报告目录
    ├── test_report.html    # HTML 测试报告
    ├── coverage_html/      # 覆盖率报告
    └── pytest_results.log # 测试日志
```

## 测试用例详情

### 1. 单元测试 (test_api.py)

#### 测试覆盖范围
- **健康检查接口**: 验证系统状态和组件健康度
- **用户认证**: 登录、登出、权限验证
- **店铺管理**: CRUD操作、配置管理
- **知识库管理**: 条目CRUD、搜索功能
- **消息处理**: 消息创建、处理、状态更新
- **审核队列**: 审核项管理、状态流转
- **统计功能**: 数据统计、报表生成
- **用户管理**: 用户CRUD、角色管理
- **千牛自动化**: UI自动化接口测试

#### 测试用例示例
```python
import pytest
from app import create_app, db
from models import User, Shop, Message

@pytest.fixture
def app():
    """测试应用"""
    app = create_app('testing')
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """测试客户端"""
    return app.test_client()

def test_health_check(client):
    """测试健康检查接口"""
    response = client.get('/health')
    assert response.status_code == 200
    assert response.json['status'] == 'ok'

def test_user_login_success(client):
    """测试用户登录成功"""
    # 创建测试用户
    user = User(username='test', role='admin')
    user.set_password('password')
    db.session.add(user)
    db.session.commit()
    
    # 测试登录
    response = client.post('/api/auth/login', json={
        'username': 'test',
        'password': 'password'
    })
    
    assert response.status_code == 200
    assert response.json['ok'] is True
    assert 'user' in response.json

def test_create_shop(client):
    """测试创建店铺"""
    response = client.post('/api/shops', json={
        'name': '测试店铺',
        'qianniu_title': '千牛-测试店铺',
        'ocr_region': [800, 200, 600, 300],
        'unread_threshold': 0.02
    })
    
    assert response.status_code == 201
    assert response.json['name'] == '测试店铺'

def test_get_shop_list(client):
    """测试获取店铺列表"""
    # 创建测试数据
    shop = Shop(name='测试店铺', qianniu_title='千牛-测试店铺')
    db.session.add(shop)
    db.session.commit()
    
    response = client.get('/api/shops')
    assert response.status_code == 200
    assert len(response.json) == 1
    assert response.json[0]['name'] == '测试店铺'
```

### 2. 前端测试 (test_frontend.py)

#### 测试覆盖范围
- **路由访问**: 前端路由可访问性
- **CORS配置**: 跨域资源共享设置
- **构建集成**: 前端构建产物集成
- **API响应**: 响应格式一致性
- **错误处理**: 异常情况处理
- **数据验证**: 输入数据验证
- **分页功能**: 分页查询功能
- **搜索功能**: 搜索和过滤功能
- **批量操作**: 批量导入导出
- **性能指标**: 响应时间和性能

#### 测试用例示例
```python
def test_frontend_routes(client):
    """测试前端路由可访问性"""
    routes = ['/', '/login', '/shops', '/messages', '/audit']
    
    for route in routes:
        response = client.get(route)
        assert response.status_code in [200, 302]  # 200或重定向

def test_cors_headers(client):
    """测试CORS配置"""
    response = client.options('/api/shops')
    assert 'Access-Control-Allow-Origin' in response.headers
    assert 'Access-Control-Allow-Methods' in response.headers

def test_api_response_format(client):
    """测试API响应格式"""
    response = client.get('/api/shops')
    assert response.status_code == 200
    
    data = response.json
    assert isinstance(data, list)
    
    if data:
        shop = data[0]
        required_fields = ['id', 'name', 'qianniu_title']
        for field in required_fields:
            assert field in shop
```

### 3. 集成测试 (test_integration.py)

#### 测试覆盖范围
- **完整工作流程**: 登录→配置→知识库→消息处理→审核
- **多店铺工作流程**: 多店铺配置和管理
- **知识库工作流程**: 知识库完整生命周期
- **审核工作流程**: 审核流程完整测试
- **统计工作流程**: 统计功能完整测试
- **用户管理工作流程**: 用户管理完整流程
- **错误恢复工作流程**: 错误处理和恢复
- **性能工作流程**: 性能基准测试
- **数据一致性工作流程**: 数据一致性验证

#### 测试用例示例
```python
def test_complete_workflow(client):
    """测试完整工作流程"""
    # 1. 用户登录
    login_response = client.post('/api/auth/login', json={
        'username': 'admin',
        'password': 'admin123'
    })
    assert login_response.status_code == 200
    
    # 2. 创建店铺
    shop_response = client.post('/api/shops', json={
        'name': '测试店铺',
        'qianniu_title': '千牛-测试店铺'
    })
    assert shop_response.status_code == 201
    shop_id = shop_response.json['id']
    
    # 3. 添加知识库条目
    kb_response = client.post('/api/kb', json={
        'shop_id': shop_id,
        'question': '如何联系客服？',
        'answer': '您可以通过在线客服联系我们',
        'category': '客服咨询'
    })
    assert kb_response.status_code == 201
    
    # 4. 创建消息
    message_response = client.post('/api/messages', json={
        'shop_id': shop_id,
        'customer_id': 'customer_001',
        'content': '如何联系客服？'
    })
    assert message_response.status_code == 201
    message_id = message_response.json['id']
    
    # 5. 处理消息
    process_response = client.post('/api/messages/process', json={
        'message_id': message_id
    })
    assert process_response.status_code == 200
    assert 'reply' in process_response.json
    
    # 6. 检查审核队列
    audit_response = client.get('/api/audit')
    assert audit_response.status_code == 200
    assert isinstance(audit_response.json, list)
```

### 4. 测试工具 (test_utils.py)

#### 工具类功能
- **TestDataGenerator**: 测试数据生成器
- **TestAssertions**: 测试断言工具
- **TestHelpers**: 测试辅助工具

#### 测试用例示例
```python
class TestDataGenerator:
    """测试数据生成器"""
    
    @staticmethod
    def create_test_user(username=None, role='admin'):
        """创建测试用户"""
        if not username:
            username = f'test_user_{random.randint(1000, 9999)}'
        
        user = User(username=username, role=role)
        user.set_password('test_password')
        return user
    
    @staticmethod
    def create_test_shop(name=None):
        """创建测试店铺"""
        if not name:
            name = f'测试店铺_{random.randint(1000, 9999)}'
        
        return Shop(
            name=name,
            qianniu_title=f'千牛-{name}',
            config_json='{"ocr_region": [800, 200, 600, 300]}'
        )
    
    @staticmethod
    def create_test_message(shop_id, content=None):
        """创建测试消息"""
        if not content:
            content = f'测试消息_{random.randint(1000, 9999)}'
        
        return Message(
            shop_id=shop_id,
            customer_id=f'customer_{random.randint(1000, 9999)}',
            content=content
        )

class TestAssertions:
    """测试断言工具"""
    
    @staticmethod
    def assert_success_response(response, expected_data=None):
        """断言成功响应"""
        assert response.status_code == 200
        data = response.json
        assert data.get('ok') is True
        
        if expected_data:
            assert data.get('data') == expected_data
    
    @staticmethod
    def assert_error_response(response, expected_error=None):
        """断言错误响应"""
        assert response.status_code >= 400
        data = response.json
        assert data.get('ok') is False
        
        if expected_error:
            assert data.get('error') == expected_error

class TestHelpers:
    """测试辅助工具"""
    
    @staticmethod
    def wait_for_condition(condition, timeout=5, interval=0.1):
        """等待条件满足"""
        start_time = time.time()
        while time.time() - start_time < timeout:
            if condition():
                return True
            time.sleep(interval)
        return False
    
    @staticmethod
    def cleanup_test_data():
        """清理测试数据"""
        # 清理所有测试数据
        db.session.query(Message).delete()
        db.session.query(Shop).delete()
        db.session.query(User).delete()
        db.session.commit()
```

## 测试运行

### 1. 运行方式

#### Python脚本
```bash
# 运行所有测试
python tests/run_tests.py

# 运行特定测试
python tests/run_tests.py --unit
python tests/run_tests.py --integration
python tests/run_tests.py --frontend
python tests/run_tests.py --coverage
python tests/run_tests.py --html
```

#### Windows批处理
```cmd
# 运行所有测试
run_tests.bat

# 运行特定测试
run_tests.bat --unit
run_tests.bat --integration
run_tests.bat --frontend
run_tests.bat --coverage
run_tests.bat --html
```

#### PowerShell脚本
```powershell
# 运行所有测试
.\run_tests.ps1

# 运行特定测试
.\run_tests.ps1 -Unit
.\run_tests.ps1 -Integration
.\run_tests.ps1 -Frontend
.\run_tests.ps1 -Coverage
.\run_tests.ps1 -Html
```

#### 直接使用pytest
```bash
# 运行所有测试
pytest tests/

# 运行特定文件
pytest tests/test_api.py

# 运行特定测试
pytest tests/test_api.py::test_login_success

# 运行带标记的测试
pytest -m "unit"
pytest -m "integration"
pytest -m "not slow"
```

### 2. 测试报告

#### HTML报告
```bash
# 生成HTML测试报告
python tests/run_tests.py --html

# 查看报告
open reports/test_report.html
```

#### 覆盖率报告
```bash
# 生成覆盖率报告
python tests/run_tests.py --coverage

# 查看覆盖率报告
open reports/coverage_html/index.html
```

#### 测试日志
```bash
# 查看测试日志
tail -f reports/pytest_results.log

# 查看错误日志
grep "ERROR" reports/pytest_results.log
```

## 测试配置

### 1. pytest.ini
```ini
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    --color=yes
markers =
    unit: 单元测试
    integration: 集成测试
    frontend: 前端测试
    slow: 慢速测试
    api: API测试
    database: 数据库测试
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
```

### 2. conftest.py
```python
import pytest
from app import create_app, db
from models import User, Shop, Message

@pytest.fixture(scope='session')
def app():
    """测试应用"""
    app = create_app('testing')
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """测试客户端"""
    return app.test_client()

@pytest.fixture
def auth_headers(client):
    """认证头"""
    response = client.post('/api/auth/login', json={
        'username': 'admin',
        'password': 'admin123'
    })
    token = response.json.get('token')
    return {'Authorization': f'Bearer {token}'}

@pytest.fixture
def test_user(app):
    """测试用户"""
    user = User(username='test', role='admin')
    user.set_password('password')
    db.session.add(user)
    db.session.commit()
    return user

@pytest.fixture
def test_shop(app):
    """测试店铺"""
    shop = Shop(name='测试店铺', qianniu_title='千牛-测试店铺')
    db.session.add(shop)
    db.session.commit()
    return shop
```

### 3. 测试环境配置
```python
# 测试环境配置
class TestingConfig:
    """测试环境配置"""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'
    WTF_CSRF_ENABLED = False
    LOGIN_DISABLED = True
```

## 测试数据

### 1. 测试用户
```python
# 默认管理员
admin_user = {
    'username': 'admin',
    'password': 'admin123',
    'role': 'superadmin'
}

# 测试用户
test_users = [
    {'username': 'test_admin', 'password': 'password', 'role': 'admin'},
    {'username': 'test_agent', 'password': 'password', 'role': 'agent'}
]
```

### 2. 测试店铺
```python
# 测试店铺数据
test_shops = [
    {
        'name': '测试店铺1',
        'qianniu_title': '千牛-测试店铺1',
        'ocr_region': [800, 200, 600, 300],
        'unread_threshold': 0.02
    },
    {
        'name': '测试店铺2',
        'qianniu_title': '千牛-测试店铺2',
        'ocr_region': [900, 250, 700, 350],
        'unread_threshold': 0.03
    }
]
```

### 3. 测试知识库
```python
# 测试知识库数据
test_kb_items = [
    {
        'question': '如何联系客服？',
        'answer': '您可以通过在线客服联系我们',
        'category': '客服咨询',
        'keywords': '联系,客服,电话'
    },
    {
        'question': '什么时候发货？',
        'answer': '一般情况下1-2个工作日发货',
        'category': '物流配送',
        'keywords': '发货,物流,配送'
    }
]
```

## 测试最佳实践

### 1. 测试命名
```python
# 测试函数命名
def test_user_login_success():  # 测试成功场景
def test_user_login_failure():  # 测试失败场景
def test_user_login_invalid_credentials():  # 测试无效凭据
def test_user_login_missing_fields():  # 测试缺少字段

# 测试类命名
class TestUserAuthentication:  # 测试用户认证
class TestShopManagement:  # 测试店铺管理
class TestMessageProcessing:  # 测试消息处理
```

### 2. 测试结构
```python
def test_create_shop():
    """测试创建店铺"""
    # 准备 (Arrange)
    shop_data = {
        'name': '测试店铺',
        'qianniu_title': '千牛-测试店铺'
    }
    
    # 执行 (Act)
    response = client.post('/api/shops', json=shop_data)
    
    # 断言 (Assert)
    assert response.status_code == 201
    assert response.json['name'] == '测试店铺'
```

### 3. 测试隔离
```python
@pytest.fixture(autouse=True)
def cleanup_database():
    """自动清理数据库"""
    yield
    # 测试后清理
    db.session.query(Message).delete()
    db.session.query(Shop).delete()
    db.session.query(User).delete()
    db.session.commit()
```

### 4. 错误处理测试
```python
def test_create_shop_missing_name():
    """测试创建店铺缺少名称"""
    response = client.post('/api/shops', json={})
    assert response.status_code == 400
    assert 'name_required' in response.json['error']

def test_create_shop_duplicate_name():
    """测试创建店铺重复名称"""
    # 先创建一个店铺
    client.post('/api/shops', json={'name': '测试店铺'})
    
    # 尝试创建同名店铺
    response = client.post('/api/shops', json={'name': '测试店铺'})
    assert response.status_code == 400
    assert 'shop_name_exists' in response.json['error']
```

## 持续集成

### 1. GitHub Actions
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.12
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      - name: Run tests
        run: python tests/run_tests.py --coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v1
```

### 2. 测试矩阵
```yaml
strategy:
  matrix:
    python-version: [3.8, 3.9, 3.10, 3.11, 3.12]
    os: [ubuntu-latest, windows-latest, macos-latest]
```

## 故障排除

### 1. 常见问题

#### 测试失败
```bash
# 检查数据库连接
python -c "from app import db; print('数据库连接正常')"

# 验证环境变量
python -c "import os; print(os.environ.get('DATABASE_URL'))"

# 查看测试日志
tail -f reports/pytest_results.log
```

#### 依赖问题
```bash
# 更新pip
pip install --upgrade pip

# 重新安装依赖
pip install -r requirements.txt

# 检查虚拟环境
which python
```

#### 权限问题
```bash
# 检查文件权限
ls -la tests/

# 验证数据库权限
python -c "from app import db; db.create_all()"
```

### 2. 调试技巧

#### 详细输出
```bash
pytest -v -s tests/test_api.py
```

#### 调试特定测试
```bash
pytest --pdb tests/test_api.py::test_login_success
```

#### 查看测试收集
```bash
pytest --collect-only tests/
```

## 测试维护

### 1. 定期更新
- 更新测试用例
- 添加新功能测试
- 修复过时测试

### 2. 性能优化
- 优化慢测试
- 并行执行测试
- 减少测试数据

### 3. 代码质量
- 保持测试代码简洁
- 使用有意义的断言
- 添加适当的注释

## 总结

智能客服系统测试体系包含：

1. **测试用例总数**: 55个
   - 单元测试: 15个
   - 前端测试: 18个
   - 集成测试: 9个
   - 测试工具: 4个
   - 测试配置: 9个

2. **测试覆盖范围**: 全面
   - API端点功能
   - 前端组件功能
   - 端到端业务流程
   - 测试工具和配置

3. **测试运行方式**: 多样化
   - Python脚本
   - Windows批处理
   - PowerShell脚本
   - 直接pytest命令

4. **测试报告**: 完整
   - HTML测试报告
   - 覆盖率报告
   - 测试日志

5. **测试配置**: 完善
   - pytest配置
   - 覆盖率配置
   - 环境配置

6. **测试文档**: 详细
   - 测试指南
   - 最佳实践
   - 故障排除

该测试体系为智能客服系统提供了全面的质量保障，确保系统的稳定性和可靠性。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-21  
**维护人员**: 测试团队
