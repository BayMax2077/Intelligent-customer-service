# 智能客服系统部署指南

## 概述

本文档详细描述了智能客服系统在Windows和Linux环境下的部署方法，包括环境准备、安装步骤、配置说明、服务启动和故障排除。

## 部署架构

### 系统架构
```
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│  前端应用    │ ←──→ │  后端API     │ ←──→ │  数据库     │
│  (Vue 3)    │      │  (Flask)     │      │  (SQLite)   │
└─────────────┘      └──────────────┘      └─────────────┘
       │                      │                      │
       │                      │                      │
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│  Nginx      │      │  任务调度     │      │  文件存储   │
│  (反向代理)  │      │  (APScheduler)│      │  (数据目录)  │
└─────────────┘      └──────────────┘      └─────────────┘
```

## Windows部署

### 1. 环境要求

#### 系统要求
- **操作系统**: Windows 10/11 (64位)
- **内存**: 至少4GB RAM
- **磁盘空间**: 至少2GB可用空间
- **网络**: 稳定的网络连接

#### 软件要求
- **Python**: 3.12+ (推荐使用官方安装包)
- **Node.js**: 18+ (推荐使用LTS版本)
- **Git**: 2.0+ (用于代码管理)

### 2. 快速部署

#### 一键部署脚本
```batch
@echo off
echo 智能客服系统 - Windows一键部署
echo ================================

echo 1. 检查环境...
python --version
if %errorlevel% neq 0 (
    echo 错误: Python未安装或版本过低
    pause
    exit /b 1
)

node --version
if %errorlevel% neq 0 (
    echo 错误: Node.js未安装或版本过低
    pause
    exit /b 1
)

echo 2. 安装Python依赖...
cd houduan
pip install -r requirements.txt
if %errorlevel% neq 0 (
    echo 错误: Python依赖安装失败
    pause
    exit /b 1
)

echo 3. 安装前端依赖...
cd ..\qianduan
npm install
if %errorlevel% neq 0 (
    echo 错误: 前端依赖安装失败
    pause
    exit /b 1
)

echo 4. 构建前端...
npm run build
if %errorlevel% neq 0 (
    echo 错误: 前端构建失败
    pause
    exit /b 1
)

echo 5. 初始化数据库...
cd ..\houduan
python -m flask db upgrade
if %errorlevel% neq 0 (
    echo 错误: 数据库初始化失败
    pause
    exit /b 1
)

echo 6. 启动服务...
start_all.bat

echo 部署完成！
echo 前端访问: http://localhost:5174
echo 后端API: http://localhost:5002
pause
```

#### 启动服务脚本
```batch
@echo off
echo 启动智能客服系统服务...
echo ========================

echo 启动后端服务...
start "后端服务" cmd /k "cd houduan && python -m houduan.app"

echo 等待后端服务启动...
timeout /t 5 /nobreak > nul

echo 启动前端服务...
start "前端服务" cmd /k "cd qianduan && npm run preview -- --port 5174"

echo 服务启动完成！
echo 前端访问: http://localhost:5174
echo 后端API: http://localhost:5002
echo 按任意键退出...
pause > nul
```

### 3. 手动部署步骤

#### 步骤1: 环境准备
```cmd
# 检查Python版本
python --version

# 检查Node.js版本
node --version

# 检查Git版本
git --version
```

#### 步骤2: 安装后端依赖
```cmd
cd houduan
pip install -r requirements.txt
```

#### 步骤3: 安装前端依赖
```cmd
cd qianduan
npm install
```

#### 步骤4: 构建前端
```cmd
npm run build
```

#### 步骤5: 初始化数据库
```cmd
cd ..\houduan
python -m flask db upgrade
```

#### 步骤6: 启动服务
```cmd
# 启动后端
python -m houduan.app

# 启动前端（新终端）
cd qianduan
npm run preview -- --port 5174
```

### 4. 服务管理

#### 启动服务
```cmd
# 使用批处理脚本
start_all.bat

# 手动启动
start "后端" cmd /k "cd houduan && python -m houduan.app"
start "前端" cmd /k "cd qianduan && npm run preview -- --port 5174"
```

#### 停止服务
```cmd
# 关闭所有相关进程
taskkill /f /im python.exe
taskkill /f /im node.exe
```

#### 重启服务
```cmd
# 停止服务
taskkill /f /im python.exe
taskkill /f /im node.exe

# 等待5秒
timeout /t 5 /nobreak > nul

# 启动服务
start_all.bat
```

## Linux部署

### 1. 环境要求

#### 系统要求
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **内存**: 至少4GB RAM
- **磁盘空间**: 至少2GB可用空间
- **网络**: 稳定的网络连接

#### 软件要求
- **Python**: 3.12+
- **Node.js**: 18+
- **Docker**: 20.10+ (可选)
- **Docker Compose**: 2.0+ (可选)

### 2. Docker部署

#### 使用Docker Compose
```bash
# 1. 克隆项目
git clone <项目地址>
cd 智能客服

# 2. 配置环境变量
cp .env.example .env
vim .env

# 3. 启动服务
docker-compose up -d

# 4. 初始化数据库
docker-compose exec backend python -m flask db upgrade

# 5. 查看服务状态
docker-compose ps
```

#### Docker Compose配置
```yaml
version: '3.8'

services:
  backend:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=sqlite:///data/sqlite.db
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped

  frontend:
    build:
      context: ./qianduan
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
```

### 3. 手动部署

#### 步骤1: 系统更新
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 步骤2: 安装Python
```bash
# Ubuntu/Debian
sudo apt install python3.12 python3.12-pip python3.12-venv -y

# CentOS/RHEL
sudo yum install python3.12 python3.12-pip -y
```

#### 步骤3: 安装Node.js
```bash
# 使用NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或使用nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

#### 步骤4: 部署应用
```bash
# 1. 克隆项目
git clone <项目地址>
cd 智能客服

# 2. 创建虚拟环境
python3.12 -m venv venv
source venv/bin/activate

# 3. 安装后端依赖
cd houduan
pip install -r requirements.txt

# 4. 安装前端依赖
cd ../qianduan
npm install

# 5. 构建前端
npm run build

# 6. 初始化数据库
cd ../houduan
python -m flask db upgrade
```

#### 步骤5: 配置Nginx
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /path/to/qianduan/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API
    location /api {
        proxy_pass http://localhost:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 步骤6: 配置系统服务
```ini
# /etc/systemd/system/smart-cs-backend.service
[Unit]
Description=Smart CS Backend Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/智能客服/houduan
Environment=PATH=/path/to/智能客服/venv/bin
ExecStart=/path/to/智能客服/venv/bin/python -m houduan.app
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# 启用服务
sudo systemctl enable smart-cs-backend
sudo systemctl start smart-cs-backend
sudo systemctl status smart-cs-backend
```

## 配置说明

### 1. 环境变量配置

#### 后端配置
```bash
# 数据库配置
DATABASE_URL=sqlite:///data/sqlite.db
# 或 MySQL
DATABASE_URL=mysql://user:password@localhost:3306/smart_cs

# Flask配置
FLASK_ENV=production
SECRET_KEY=your-secret-key-here

# AI模型配置
OPENAI_API_KEY=your-openai-api-key
OPENAI_MODEL=gpt-4o-mini

# 告警配置
ALERT_EMAIL_USERNAME=your-email@example.com
ALERT_EMAIL_PASSWORD=your-email-password
ALERT_EMAIL_TO=admin@example.com
```

#### 前端配置
```bash
# API基础URL
VITE_API_BASE=http://localhost:5002

# 应用标题
VITE_APP_TITLE=智能客服系统
```

### 2. 数据库配置

#### SQLite配置
```python
# 开发环境
SQLALCHEMY_DATABASE_URI = 'sqlite:///data/sqlite.db'

# 生产环境
SQLALCHEMY_DATABASE_URI = 'sqlite:///var/lib/smart-cs/sqlite.db'
```

#### MySQL配置
```python
# 生产环境MySQL
SQLALCHEMY_DATABASE_URI = 'mysql://user:password@localhost:3306/smart_cs'
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_pre_ping': True,
    'pool_recycle': 300,
    'pool_size': 10,
    'max_overflow': 20
}
```

### 3. Nginx配置

#### 基础配置
```nginx
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # 基础配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 包含站点配置
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

#### 站点配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 前端静态文件
    location / {
        root /var/www/smart-cs/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # 后端API
    location /api {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:5002/health;
        access_log off;
    }
}
```

## 服务管理

### 1. 服务启动

#### Windows服务
```cmd
# 启动所有服务
start_all.bat

# 启动后端服务
cd houduan
python -m houduan.app

# 启动前端服务
cd qianduan
npm run preview -- --port 5174
```

#### Linux服务
```bash
# 启动后端服务
sudo systemctl start smart-cs-backend

# 启动Nginx
sudo systemctl start nginx

# 查看服务状态
sudo systemctl status smart-cs-backend
sudo systemctl status nginx
```

### 2. 服务监控

#### 健康检查
```bash
# 检查后端健康状态
curl http://localhost:5002/health

# 检查前端访问
curl http://localhost:5174

# 检查API接口
curl http://localhost:5002/api/shops
```

#### 日志监控
```bash
# 查看后端日志
tail -f logs/app.log

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 查看系统服务日志
journalctl -u smart-cs-backend -f
```

### 3. 服务维护

#### 重启服务
```bash
# Windows
taskkill /f /im python.exe
taskkill /f /im node.exe
start_all.bat

# Linux
sudo systemctl restart smart-cs-backend
sudo systemctl restart nginx
```

#### 更新服务
```bash
# 1. 停止服务
sudo systemctl stop smart-cs-backend

# 2. 备份数据
cp -r data data_backup_$(date +%Y%m%d_%H%M%S)

# 3. 更新代码
git pull origin main

# 4. 更新依赖
pip install -r requirements.txt
npm install

# 5. 数据库迁移
python -m flask db upgrade

# 6. 重启服务
sudo systemctl start smart-cs-backend
```

## 故障排除

### 1. 常见问题

#### 端口冲突
```bash
# 检查端口占用
netstat -tulpn | grep :5002
netstat -tulpn | grep :5174

# 杀死占用进程
sudo kill -9 <PID>
```

#### 权限问题
```bash
# 检查文件权限
ls -la data/
ls -la logs/

# 修复权限
sudo chown -R www-data:www-data data/
sudo chmod -R 755 data/
```

#### 依赖问题
```bash
# 重新安装依赖
pip install -r requirements.txt --force-reinstall
npm install --force
```

### 2. 日志分析

#### 后端日志
```bash
# 查看错误日志
grep "ERROR" logs/app.log

# 查看警告日志
grep "WARNING" logs/app.log

# 查看访问日志
grep "GET\|POST" logs/app.log
```

#### 前端日志
```bash
# 查看构建日志
npm run build 2>&1 | tee build.log

# 查看预览日志
npm run preview 2>&1 | tee preview.log
```

### 3. 性能优化

#### 数据库优化
```sql
-- 创建索引
CREATE INDEX idx_messages_shop_id ON messages(shop_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);

-- 分析查询性能
EXPLAIN QUERY PLAN SELECT * FROM messages WHERE shop_id = 1;
```

#### 缓存配置
```python
# Redis缓存配置
CACHE_TYPE = 'redis'
CACHE_REDIS_URL = 'redis://localhost:6379/0'
CACHE_DEFAULT_TIMEOUT = 300
```

## 安全配置

### 1. 防火墙配置

#### Ubuntu/Debian
```bash
# 安装UFW
sudo apt install ufw -y

# 配置防火墙规则
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

#### CentOS/RHEL
```bash
# 配置firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. SSL证书配置

#### Let's Encrypt证书
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. 数据备份

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/var/backups/smart-cs"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp data/sqlite.db $BACKUP_DIR/sqlite_$DATE.db

# 备份配置文件
cp -r config $BACKUP_DIR/config_$DATE

# 压缩备份
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz $BACKUP_DIR/sqlite_$DATE.db $BACKUP_DIR/config_$DATE

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR/backup_$DATE.tar.gz"
```

## 总结

智能客服系统部署指南包含：

1. **部署架构**: 清晰的服务架构图
2. **Windows部署**: 一键部署脚本和手动部署步骤
3. **Linux部署**: Docker和手动部署两种方式
4. **配置说明**: 环境变量、数据库、Nginx配置
5. **服务管理**: 启动、监控、维护方法
6. **故障排除**: 常见问题和解决方案
7. **安全配置**: 防火墙、SSL证书、数据备份

该部署指南为智能客服系统提供了完整的部署解决方案，确保系统能够稳定、安全地运行在生产环境中。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-21  
**维护人员**: 运维团队
