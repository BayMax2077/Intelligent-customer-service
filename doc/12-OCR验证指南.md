# OCR验证指南

## 概述

本指南介绍如何使用微信PC客户端验证PaddleOCR功能和完整的消息捕获流程。通过此验证，可以确保系统能够正确识别微信聊天内容并进行消息去重处理。

## 环境准备

### 系统要求
- **操作系统**: Windows 10/11
- **Python版本**: 3.8+
- **微信版本**: 最新版PC客户端

### 依赖安装

1. **安装Python依赖**
   ```bash
   pip install -r requirements.txt
   ```

2. **验证关键依赖**
   - `paddleocr>=2.7.0` - OCR识别引擎
   - `paddlepaddle>=2.5.0` - 深度学习框架
   - `pywin32` - Windows API访问
   - `pyautogui` - 屏幕截图和自动化
   - `Pillow` - 图像处理
   - `imagehash` - 图像哈希计算

## 验证步骤

### 1. 准备微信环境

1. **打开微信PC客户端**
   - 确保微信已登录
   - 打开一个聊天窗口（建议使用"文件传输助手"）
   - 发送几条测试消息

2. **调整窗口位置**
   - 将微信窗口放在屏幕中央
   - 确保聊天内容区域可见
   - 不要最小化或遮挡窗口

### 2. 运行验证脚本

```bash
python scripts/verify_ocr.py
```

### 3. 配置OCR区域

脚本会提示输入OCR区域坐标，格式为 `x,y,w,h`：

- **x, y**: 区域左上角坐标
- **w, h**: 区域宽度和高度

**推荐配置**：
- 默认区域：`600,150,800,600`
- 如果微信窗口位置不同，请相应调整

**如何获取正确坐标**：
1. 使用Windows自带的截图工具
2. 截图时注意左上角显示的坐标
3. 确保区域覆盖聊天文字内容

### 4. 验证结果解读

脚本会输出6个阶段的验证结果：

#### 阶段1: 环境检查
- ✓ 所有依赖已安装
- ✗ 部分依赖缺失（需要安装）

#### 阶段2: OCR基础测试
- ✓ OCR功能正常
- ✗ OCR初始化失败

#### 阶段3: 微信窗口检测
- ✓ 找到N个微信窗口
- ⚠ 未找到微信窗口

#### 阶段4: 红点检测测试
- ✓ 红点检测分数: 0.035
- ⚠ 红点检测分数过低

#### 阶段5: 完整流程测试
- ✓ OCR识别成功，识别到N字
- ⚠ OCR未识别到文字

#### 阶段6: 消息去重测试
- ✓ 消息去重机制正常
- ✗ 消息去重机制异常

## 常见问题排查

### 1. PaddleOCR安装失败

**问题**: `pip install paddleocr` 失败

**解决方案**:
```bash
# 先安装paddlepaddle
pip install paddlepaddle

# 再安装paddleocr
pip install paddleocr
```

**如果仍然失败**:
```bash
# 使用清华源
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple paddleocr
```

### 2. OCR识别率低

**问题**: OCR识别出的文字很少或错误

**解决方案**:
1. **调整OCR区域**
   - 确保区域完全覆盖聊天内容
   - 避免包含窗口边框和按钮

2. **检查图像质量**
   - 确保微信窗口清晰可见
   - 避免模糊或过小的文字

3. **调整识别参数**
   - 在验证脚本中，OCR使用默认参数
   - 生产环境可以调整置信度阈值

### 3. 红点检测不准确

**问题**: 红点检测分数异常

**解决方案**:
1. **调整检测区域**
   - 红点通常在聊天窗口的特定位置
   - 确保区域包含可能的红点位置

2. **调整阈值**
   - 默认阈值：0.02
   - 如果误报，可以提高到0.05
   - 如果漏报，可以降低到0.01

### 4. 微信窗口检测失败

**问题**: 找不到微信窗口

**解决方案**:
1. **检查微信是否运行**
   - 确保微信PC客户端已启动
   - 检查任务管理器中是否有WeChat进程

2. **检查窗口标题**
   - 微信窗口标题通常包含"微信"
   - 如果使用英文版，可能显示"WeChat"

3. **权限问题**
   - 确保Python有权限访问窗口信息
   - 以管理员身份运行验证脚本

### 5. 图像哈希检测异常

**问题**: 图像变化检测不敏感或过于敏感

**解决方案**:
1. **调整hash_threshold参数**
   - 默认值：5
   - 值越小越敏感（1-3）
   - 值越大越不敏感（8-10）

2. **检查区域稳定性**
   - 确保OCR区域不会频繁变化
   - 避免包含动态元素（如时间显示）

## 性能优化建议

### 1. OCR性能优化

- **模型选择**: 使用轻量级模型（如果可用）
- **区域优化**: 只截取必要的文字区域
- **缓存机制**: 利用现有的图像哈希缓存

### 2. 系统资源优化

- **内存使用**: PaddleOCR首次运行会下载模型（约8MB）
- **CPU使用**: OCR识别是CPU密集型操作
- **网络使用**: 首次运行需要下载模型文件

### 3. 监控建议

- **识别率监控**: 定期检查OCR识别准确率
- **性能监控**: 监控OCR处理时间
- **错误监控**: 记录识别失败的情况

## 生产环境配置

验证通过后，可以按以下步骤配置生产环境：

### 1. 添加微信店铺配置

通过前端"店铺配置"页面添加微信配置：

```json
{
  "name": "微信客服",
  "qianniu_title": "微信",
  "ocr_region": [600, 150, 800, 600],
  "unread_threshold": 0.02,
  "hash_threshold": 5,
  "ai_model": "qwen",
  "auto_mode": false
}
```

### 2. 启用调度器

确保调度器正常运行，定期执行消息监控：

```python
# 在houduan/services/scheduler.py中
# 调度器会自动调用qianniu_monitor.py中的监控函数
```

### 3. 监控和调试

- **日志记录**: 查看OCR识别日志
- **性能监控**: 监控处理时间和成功率
- **错误处理**: 处理OCR识别失败的情况

## 故障排除清单

在遇到问题时，请按以下顺序检查：

- [ ] Python依赖是否完整安装
- [ ] 微信PC客户端是否正常运行
- [ ] OCR区域坐标是否正确
- [ ] 微信窗口是否可见且未被遮挡
- [ ] 系统DPI设置是否影响坐标
- [ ] 防火墙是否阻止Python访问屏幕
- [ ] PaddleOCR模型是否下载完成
- [ ] 网络连接是否正常（首次运行需要下载模型）

## 联系支持

如果遇到无法解决的问题，请提供以下信息：

1. **系统信息**: Windows版本、Python版本
2. **错误日志**: 完整的错误信息和堆栈跟踪
3. **配置信息**: OCR区域坐标、阈值设置
4. **测试环境**: 微信版本、窗口状态

---

*最后更新: 2024年12月*
