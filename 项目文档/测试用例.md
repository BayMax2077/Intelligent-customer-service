# 智能客服系统测试用例 v2.0

本文档用于快速验证从"千牛监控→OCR→入库→知识库/AI→审核→发送"的端到端链路。

> **当前版本配置**：
> - 后端地址：`http://127.0.0.1:5000`
> - 前端地址：`http://localhost:5173`
> - 数据库：SQLite (`data/sqlite.db`)
> - 默认管理员：`admin/admin`

## 1. 登录
- 账号：`admin`
- 密码：`admin`
- 预期：返回 `{ ok: true }`，前端跳转到“店铺配置”。若失败，弹窗展示“请求URL/方法/请求头/响应状态码/响应头/返回体摘要”。

---

## 2. 店铺配置用例
在前端"店铺配置"页点击"新增店铺配置"按钮，填写配置信息。

### 2.1 基础配置测试
- **店铺名称**：`测试店铺`
- **千牛标题**：`千牛-测试店铺`
- **OCR区域**：`800,200,600,300`
- **未读阈值**：`0.02`
- **AI模型**：`stub`
- **自动模式**：关闭
- **预期**：配置保存成功，店铺出现在列表中

### 2.2 不同分辨率配置

- **1920×1080 分辨率**
  - OCR区域：`1100,200,700,450`
  - 未读阈值：`0.03`
  - AI模型：`stub`
  - 自动模式：关闭

- **1366×768 分辨率**
  - OCR区域：`780,180,520,360`
  - 未读阈值：`0.04`
  - AI模型：`stub`
  - 自动模式：关闭

- **2560×1440 分辨率**
  - OCR区域：`1600,300,800,500`
  - 未读阈值：`0.025`
  - AI模型：`stub`
  - 自动模式：关闭

### 2.3 高级配置测试
- **黑白名单配置**
  - 黑名单：`customer001\ncustomer002`
  - 白名单：`vip001\nvip002`
  - 预期：配置正确保存

- **营业时间配置**
  - 营业时间：`09:00-18:00`
  - 回复延迟：`2秒`
  - 预期：配置正确保存

### 2.4 删除店铺测试
- **操作步骤**：
  1. 点击店铺列表中的"删除"按钮
  2. 查看确认对话框是否显示详细警告信息
  3. 确认删除操作
- **预期结果**：
  - 显示详细的删除警告信息
  - 列出所有会被删除的关联数据
  - 删除成功后店铺从列表中消失

---

## 3. 系统健康检查
### 3.1 后端服务检查
- **健康检查**
  - GET `http://127.0.0.1:5000/health`
  - 预期：返回 `{"status":"ok","message":"服务运行正常"}`

### 3.2 前端服务检查
- **页面访问**
  - 访问 `http://localhost:5173`
  - 预期：显示登录页面，无错误信息

## 4. 未读探针与 OCR 采集（后端 API）
> 先在千牛中确保有未读提示或聊天内容窗口可见。

### 4.1 未读探针测试
- **API调用**
  - POST `/api/qianniu/unread_probe`
  - Body：
    ```json
    { "region": [800,200,300,300] }
    ```
  - 预期：返回 `{ "score": 0.x }`，若 `score ≥ 未读阈值` 说明会触发 OCR

### 4.2 OCR 采集测试
- **API调用**
  - POST `/api/qianniu/ocr_capture`
  - Body：
    ```json
    { "region": [800,200,600,300], "shop_id": 1, "customer_id": "test-user-1" }
    ```
  - 预期：返回 `{ "id": N, "content_len": >0 或 0, "empty": false/true }`；`id` 为消息ID

---

## 5. 消息管理测试
### 5.1 消息列表查看
- **前端操作**
  - 访问"消息列表"页面
  - 预期：显示消息列表，包含消息ID、客户ID、内容预览、状态等

### 5.2 消息处理测试
- **KB 高置信命中（退款）**
  - 文本包含：`退款/退货/售后/refund`
  - POST `/api/messages/process`
    ```json
    { "message_id": N }
    ```
  - 预期：`{"source":"kb","auto_send":true,"confidence":≥0.9}`，消息置为 `answered`

- **KB 低置信 + AI 建议（发票）**
  - 文本包含：`发票/invoice`
  - 预期：`{"source":"ai","auto_send":false}`，进入审核队列

- **纯 AI（无关键词）**
  - 示例文本：`今天能发货吗？`
  - 预期：`{"source":"ai","auto_send":false}`

---

## 6. 审核队列测试
### 6.1 审核队列查看
- **前端操作**
  - 访问"审核队列"页面
  - 预期：显示待审核的消息列表

- **API调用**
  - GET `/api/audit`
  - 预期：返回待审核项数组

### 6.2 审核操作测试
- **通过并发送到千牛**
  - POST `/api/audit/approve`
    ```json
    { "id": 待审核项ID, "title_kw": "千牛" }
    ```
  - 预期：千牛窗口被激活并发送文本；`messages.status = answered`

- **拒绝审核**
  - POST `/api/audit/reject`
    ```json
    { "id": 待审核项ID }
    ```
  - 预期：`AIReply.review_status = rejected`，`messages.status = queued`

---

## 7. 知识库管理测试
### 7.1 知识库条目管理
- **添加知识库条目**
  - 访问"知识库管理"页面
  - 点击"新增"按钮
  - 填写问题、答案、分类、关键词
  - 预期：条目成功保存并显示在列表中

- **编辑知识库条目**
  - 点击现有条目的"编辑"按钮
  - 修改内容后保存
  - 预期：修改成功，内容更新

- **删除知识库条目**
  - 点击"删除"按钮
  - 确认删除操作
  - 预期：条目从列表中消失

## 8. 统计报表测试
### 8.1 统计数据显示
- **访问统计页面**
  - 访问"统计报表"页面
  - 预期：显示各种统计数据（消息数量、回复率、AI使用情况等）

## 9. 用户管理测试
### 9.1 用户列表查看
- **访问用户管理**
  - 访问"用户管理"页面
  - 预期：显示用户列表，包含用户名、角色、所属店铺等

### 9.2 用户权限测试
- **不同角色权限**
  - 超级管理员：可管理所有店铺和用户
  - 店铺管理员：只能管理所属店铺
  - 客服代理：只能处理消息和审核

## 10. 自动模式测试
### 10.1 自动模式配置
- **条件**：店铺配置中`自动模式=开启`，`未读阈值=0.02`
- **步骤**：保持千牛聊天列表出现未读；轮询每 10s 自动 OCR 入库
- **预期**：
  - KB 高置信文本自动回答并置 `answered`
  - 低置信/敏感进入审核队列

## 11. AI模型配置测试
### 11.1 模型选择测试
- **Stub模型**：基础测试模型
- **通义千问**：需要配置API密钥
- **文心一言**：需要配置API密钥
- **OpenAI**：需要配置API密钥

### 11.2 OpenAI真实模型（可选）
- **环境变量配置**：
  - `OPENAI_API_KEY=你的Key`
  - `OPENAI_MODEL=gpt-4o-mini`（默认）
- **店铺配置**：`AI模型=openai`
- **预期**：`/api/messages/process` 返回更完整的建议文案

## 12. 错误处理测试
### 12.1 登录失败处理
- **触发方式**：后端临时返回 500
- **预期**：前端显示错误信息，不崩溃

### 12.2 网络异常处理
- **断开网络连接**
- **预期**：前端显示网络错误提示

## 13. 常见问题排查
### 13.1 OCR问题
- **OCR `empty=true`**
  - 原因：未安装 `paddleocr/paddlepaddle` 或区域不含文本
  - 解决：调整区域或安装依赖

### 13.2 审核问题
- **审核通过未发送**
  - 原因：`title_kw` 未匹配到千牛窗口标题
  - 解决：改成标题的唯一片段（如"千牛-旗舰店"填"千牛"/"旗舰店"）

### 13.3 轮询问题
- **轮询未入库**
  - 原因：10s 内无抓取
  - 解决：调低未读阈值或扩大 OCR 区域；确认千牛窗口可见

## 14. 性能测试
### 14.1 并发测试
- **多用户同时登录**
- **大量消息处理**
- **预期**：系统稳定运行，无崩溃

### 14.2 数据量测试
- **大量店铺配置**
- **大量消息记录**
- **预期**：系统响应正常，无明显性能下降

---

## 15. 快速启动指南

### 15.1 环境准备
1. **启动后端服务**
   ```bash
   cd "C:\Users\BayMax2077\Desktop\智能客服"
   .venv\Scripts\activate
   python -m houduan.app
   ```
   - 后端运行在：`http://127.0.0.1:5000`

2. **启动前端服务**
   ```bash
   cd qianduan
   npm install
   npm run dev
   ```
   - 前端运行在：`http://localhost:5173`

### 15.2 基础测试流程
1. **登录测试**：访问前端，使用 `admin/admin` 登录
2. **店铺配置**：创建测试店铺，配置OCR区域和阈值
3. **消息管理**：查看消息列表，测试消息处理
4. **审核队列**：测试审核通过/拒绝功能
5. **知识库**：添加知识库条目，测试AI回复
6. **统计报表**：查看系统统计数据

### 15.3 测试数据准备
- **测试店铺**：创建多个不同配置的店铺
- **测试消息**：准备包含不同关键词的消息
- **知识库条目**：添加常见问题的问答对
- **用户账号**：创建不同角色的测试用户

### 15.4 测试检查点
- ✅ 登录功能正常
- ✅ 店铺配置保存成功
- ✅ 删除店铺显示详细警告
- ✅ 消息列表正常显示
- ✅ 审核队列功能正常
- ✅ 知识库管理功能正常
- ✅ 统计报表数据正确
- ✅ 用户权限控制有效
- ✅ 错误处理机制正常
