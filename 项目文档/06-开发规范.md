# 智能客服系统开发规范

## 概述

本文档规定了智能客服系统开发过程中的代码质量标准、命名规范、注释规范、Git提交规范等，确保代码的可读性、可维护性和团队协作效率。

## 代码质量标准

### 1. 可读性与结构性

#### 命名规范
- **变量名**: 使用有意义的英文单词，采用camelCase（JavaScript/TypeScript）或snake_case（Python）
- **函数名**: 使用动词开头，清晰表达功能，如`getUserInfo`、`processMessage`
- **类名**: 使用PascalCase，如`UserManager`、`MessageHandler`
- **常量名**: 使用UPPER_SNAKE_CASE，如`MAX_RETRY_COUNT`、`API_BASE_URL`
- **文件名**: 使用kebab-case（前端）或snake_case（后端），如`user-list.vue`、`message_handler.py`

#### 代码风格
- **Python**: 遵循PEP 8规范
- **JavaScript/TypeScript**: 遵循ESLint配置
- **Vue组件**: 使用Vue 3组合式API
- **缩进**: 统一使用2个空格（前端）或4个空格（Python）

#### 函数设计
- **单一职责**: 每个函数只做一件事
- **函数长度**: 不超过50行，复杂逻辑拆分为多个函数
- **参数数量**: 不超过5个参数，多参数使用对象传递
- **返回值**: 明确返回类型，避免返回None/undefined

### 2. 注释与文档

#### 文件头注释
```python
"""
智能客服系统 - 消息处理模块

功能: 处理千牛消息的接收、解析和回复
作者: 开发团队
创建时间: 2025-01-21
最后修改: 2025-01-21
"""

/**
 * 智能客服系统 - 用户管理组件
 * 
 * 功能: 用户列表展示、添加、编辑、删除
 * 作者: 前端团队
 * 创建时间: 2025-01-21
 */
```

#### 函数注释
```python
def process_message(message: Message) -> ProcessResult:
    """
    处理消息并生成回复
    
    Args:
        message: 消息对象，包含内容和元数据
        
    Returns:
        ProcessResult: 处理结果，包含回复内容、来源和置信度
        
    Raises:
        ValueError: 当消息内容为空时
        ProcessingError: 当处理过程中发生错误时
        
    Example:
        >>> message = Message(content="你好", shop_id=1)
        >>> result = process_message(message)
        >>> print(result.reply)
        "您好！很高兴为您服务"
    """
    # 实现逻辑...
```

#### 关键逻辑注释
```python
def search_knowledge_base(content: str, shop_id: int) -> Optional[SearchResult]:
    """
    在知识库中搜索相关内容
    
    搜索策略：
    1. 向量相似度搜索（主要方法）
    2. 关键词匹配（备用方法）
    3. 正则表达式匹配（精确匹配）
    """
    # 1. 向量相似度搜索
    # 使用Sentence-Transformers将查询内容向量化
    query_vector = embed_text(content)
    
    # 2. 在向量数据库中搜索相似内容
    # 使用Faiss进行高效向量检索
    similar_items = vector_search(query_vector, shop_id)
    
    # 3. 计算置信度并返回结果
    # 置信度 = 相似度分数 * 权重系数
    confidence = calculate_confidence(similar_items)
    
    return SearchResult(
        answer=similar_items[0].answer,
        confidence=confidence,
        source='vector_search'
    )
```

### 3. 错误处理

#### 异常捕获
```python
def safe_api_call(func, *args, **kwargs):
    """安全的API调用，包含完整的错误处理"""
    try:
        return func(*args, **kwargs)
    except requests.exceptions.Timeout:
        logger.error("API调用超时")
        return None
    except requests.exceptions.ConnectionError:
        logger.error("网络连接失败")
        return None
    except requests.exceptions.HTTPError as e:
        logger.error(f"HTTP错误: {e.response.status_code}")
        return None
    except Exception as e:
        logger.error(f"未知错误: {str(e)}")
        return None
```

#### 日志记录
```python
import logging

logger = logging.getLogger(__name__)

def process_user_request(user_id: int, request_data: dict):
    """处理用户请求"""
    logger.info(f"开始处理用户 {user_id} 的请求")
    
    try:
        # 业务逻辑
        result = business_logic(request_data)
        
        logger.info(f"用户 {user_id} 请求处理成功")
        return result
        
    except ValidationError as e:
        logger.warning(f"用户 {user_id} 请求验证失败: {str(e)}")
        raise
    except ProcessingError as e:
        logger.error(f"用户 {user_id} 请求处理失败: {str(e)}")
        raise
    except Exception as e:
        logger.error(f"用户 {user_id} 请求处理异常: {str(e)}")
        raise
```

#### 用户友好的错误信息
```python
def handle_api_error(error: Exception, operation: str) -> dict:
    """处理API错误并返回用户友好的错误信息"""
    if isinstance(error, ValidationError):
        return {
            "error": "validation_error",
            "message": "请求参数验证失败",
            "details": str(error)
        }
    elif isinstance(error, PermissionError):
        return {
            "error": "permission_denied",
            "message": "权限不足，无法执行此操作"
        }
    elif isinstance(error, DatabaseError):
        return {
            "error": "database_error",
            "message": "数据库操作失败，请稍后重试"
        }
    else:
        return {
            "error": "internal_error",
            "message": "服务器内部错误，请联系技术支持"
        }
```

## 数据库设计规范

### 1. 表设计原则

#### 主键设计
```sql
-- 使用自增主键
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(64) NOT NULL UNIQUE,
    -- 其他字段...
);

-- 复合主键（适用于关联表）
CREATE TABLE user_roles (
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
);
```

#### 外键约束
```sql
-- 添加外键约束
ALTER TABLE messages ADD CONSTRAINT fk_messages_shop_id 
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE;

-- 级联删除
ALTER TABLE ai_replies ADD CONSTRAINT fk_ai_replies_message_id 
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE;
```

#### 索引设计
```sql
-- 单列索引
CREATE INDEX idx_messages_shop_id ON messages(shop_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_messages_status ON messages(status);

-- 复合索引
CREATE INDEX idx_messages_shop_status ON messages(shop_id, status);
CREATE INDEX idx_messages_shop_created ON messages(shop_id, created_at);

-- 唯一索引
CREATE UNIQUE INDEX idx_users_username ON users(username);
CREATE UNIQUE INDEX idx_shops_name ON shops(name);
```

### 2. 命名规范

#### 表名规范
```sql
-- 使用复数形式，下划线分隔
CREATE TABLE users (...);
CREATE TABLE shops (...);
CREATE TABLE messages (...);
CREATE TABLE knowledge_base (...);
CREATE TABLE ai_replies (...);
CREATE TABLE audit_queue (...);
```

#### 字段名规范
```sql
-- 使用下划线分隔，语义清晰
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(32) NOT NULL,
    shop_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 索引名规范
```sql
-- 索引命名: idx_表名_字段名
CREATE INDEX idx_messages_shop_id ON messages(shop_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_messages_shop_status ON messages(shop_id, status);
```

### 3. 数据模型示例

```python
class User(db.Model, TimestampMixin):
    """用户模型"""
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    role = db.Column(db.String(32), nullable=False, default='agent')
    shop_id = db.Column(db.Integer, db.ForeignKey('shops.id'), nullable=True)
    
    # 关系
    shop = db.relationship('Shop', backref='users')
    
    def set_password(self, password):
        """设置密码"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """验证密码"""
        return check_password_hash(self.password_hash, password)
    
    def __repr__(self):
        return f'<User {self.username}>'

class TimestampMixin:
    """时间戳混入类"""
    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
```

## API设计规范

### 1. RESTful设计

#### 资源命名
```python
# 使用名词，复数形式
GET    /api/shops          # 获取店铺列表
POST   /api/shops          # 创建店铺
GET    /api/shops/{id}     # 获取特定店铺
PUT    /api/shops/{id}     # 更新店铺
DELETE /api/shops/{id}     # 删除店铺

GET    /api/messages       # 获取消息列表
POST   /api/messages       # 创建消息
GET    /api/messages/{id}   # 获取特定消息
PUT    /api/messages/{id}   # 更新消息
DELETE /api/messages/{id}  # 删除消息
```

#### HTTP方法使用
```python
# GET: 查询数据
@api_bp.get("/shops")
def list_shops():
    """获取店铺列表"""
    pass

# POST: 创建数据
@api_bp.post("/shops")
def create_shop():
    """创建店铺"""
    pass

# PUT: 更新数据
@api_bp.put("/shops/<int:shop_id>")
def update_shop(shop_id):
    """更新店铺"""
    pass

# DELETE: 删除数据
@api_bp.delete("/shops/<int:shop_id>")
def delete_shop(shop_id):
    """删除店铺"""
    pass
```

### 2. 响应格式标准

#### 成功响应
```python
def success_response(data=None, message="操作成功"):
    """成功响应格式"""
    return jsonify({
        "ok": True,
        "data": data,
        "message": message
    })

# 使用示例
@api_bp.get("/shops")
def list_shops():
    shops = Shop.query.all()
    return success_response(
        data=[shop.to_dict() for shop in shops],
        message="获取店铺列表成功"
    )
```

#### 错误响应
```python
def error_response(error_code, message, details=None):
    """错误响应格式"""
    response = {
        "ok": False,
        "error": error_code,
        "message": message
    }
    if details:
        response["details"] = details
    return jsonify(response)

# 使用示例
@api_bp.post("/shops")
def create_shop():
    data = request.get_json()
    if not data.get('name'):
        return error_response(
            error_code="name_required",
            message="店铺名称不能为空"
        )
```

### 3. API版本管理

```python
# URL版本控制
@api_bp.route('/v1/shops', methods=['GET'])
def list_shops_v1():
    """API v1 店铺列表"""
    pass

@api_bp.route('/v2/shops', methods=['GET'])
def list_shops_v2():
    """API v2 店铺列表（增强版）"""
    pass

# 请求头版本控制
@api_bp.route('/shops', methods=['GET'])
def list_shops():
    """根据请求头版本返回不同数据"""
    api_version = request.headers.get('API-Version', 'v1')
    if api_version == 'v2':
        return enhanced_shop_list()
    else:
        return basic_shop_list()
```

## 前端开发规范

### 1. Vue 3 组件规范

#### 组件命名
```vue
<!-- 组件文件: UserList.vue -->
<template>
  <div class="user-list">
    <!-- 组件内容 -->
  </div>
</template>

<script setup lang="ts">
// 组件逻辑
</script>

<style scoped>
.user-list {
  /* 组件样式 */
}
</style>
```

#### Props定义
```vue
<script setup lang="ts">
interface Props {
  users: User[]
  loading: boolean
  pageSize: number
  showActions: boolean
}

const props = withDefaults(defineProps<Props>(), {
  users: () => [],
  loading: false,
  pageSize: 20,
  showActions: true
})
</script>
```

#### 事件命名
```vue
<template>
  <el-button @click="handleEdit">编辑</el-button>
  <el-button @click="handleDelete">删除</el-button>
</template>

<script setup lang="ts">
const emit = defineEmits<{
  'user-updated': [user: User]
  'user-deleted': [userId: number]
  'page-changed': [page: number]
}>()

const handleEdit = (user: User) => {
  emit('user-updated', user)
}

const handleDelete = (userId: number) => {
  emit('user-deleted', userId)
}
</script>
```

### 2. 代码组织

#### 组件结构
```vue
<template>
  <!-- 1. 模板内容 -->
</template>

<script setup lang="ts">
// 1. 导入
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'

// 2. 类型定义
interface User {
  id: number
  name: string
  email: string
}

// 3. Props定义
const props = defineProps<{
  users: User[]
}>()

// 4. 响应式数据
const loading = ref(false)
const selectedUser = ref<User | null>(null)

// 5. 计算属性
const filteredUsers = computed(() => {
  return props.users.filter(user => user.active)
})

// 6. 方法
const loadUsers = async () => {
  loading.value = true
  try {
    // API调用
  } finally {
    loading.value = false
  }
}

// 7. 生命周期
onMounted(() => {
  loadUsers()
})
</script>

<style scoped>
/* 组件样式 */
</style>
```

### 3. 状态管理

#### Pinia Store
```typescript
// store/auth.ts
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useAuthStore = defineStore('auth', () => {
  // 状态
  const isAuthed = ref(false)
  const username = ref('')
  const role = ref('')
  
  // 计算属性
  const isAdmin = computed(() => role.value === 'admin')
  
  // 方法
  const setAuthed = (authed: boolean, user?: string, userRole?: string) => {
    isAuthed.value = authed
    if (user) username.value = user
    if (userRole) role.value = userRole
  }
  
  const logout = () => {
    isAuthed.value = false
    username.value = ''
    role.value = ''
  }
  
  return {
    isAuthed,
    username,
    role,
    isAdmin,
    setAuthed,
    logout
  }
})
```

## Git提交规范

### 1. 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### 类型说明
- **feat**: 新功能
- **fix**: 修复bug
- **docs**: 文档更新
- **style**: 代码格式调整
- **refactor**: 代码重构
- **test**: 测试相关
- **chore**: 构建过程或辅助工具的变动

#### 示例
```bash
# 新功能
feat(auth): 添加用户登录功能

# 修复bug
fix(api): 修复店铺删除时的外键约束问题

# 文档更新
docs(api): 更新API文档，添加错误码说明

# 代码重构
refactor(components): 重构用户列表组件，提取公共逻辑

# 测试
test(api): 添加店铺管理API的单元测试
```

### 2. 分支管理

#### 分支命名
```bash
# 功能分支
feature/user-management
feature/shop-configuration
feature/message-processing

# 修复分支
fix/login-validation
fix/database-connection
fix/cors-issue

# 发布分支
release/v1.0.0
release/v1.1.0
```

#### 分支策略
```bash
# 主分支
main                    # 生产环境代码
develop                 # 开发环境代码

# 功能分支
feature/user-auth       # 用户认证功能
feature/shop-management # 店铺管理功能

# 修复分支
fix/login-bug          # 登录bug修复
fix/api-error          # API错误修复

# 发布分支
release/v1.0.0         # 版本发布
```

### 3. 代码审查

#### 审查清单
- [ ] 代码符合项目规范
- [ ] 函数和变量命名清晰
- [ ] 注释完整且准确
- [ ] 错误处理完善
- [ ] 测试用例覆盖
- [ ] 性能考虑
- [ ] 安全性检查

#### 审查流程
1. **自检**: 提交前自行检查代码
2. **同事审查**: 至少一人审查代码
3. **测试验证**: 确保测试通过
4. **合并**: 审查通过后合并到主分支

## 安全编码规范

### 1. 输入验证

#### 后端验证
```python
from marshmallow import Schema, fields, validate

class ShopCreateSchema(Schema):
    """店铺创建验证模式"""
    name = fields.Str(required=True, validate=[
        validate.Length(min=2, max=50),
        validate.Regexp(r'^[a-zA-Z0-9\u4e00-\u9fa5]+$', error='名称只能包含字母、数字和中文')
    ])
    qianniu_title = fields.Str(validate=validate.Length(max=100))
    ocr_region = fields.List(fields.Int(), validate=validate.Length(equal=4))
    unread_threshold = fields.Float(validate=validate.Range(min=0, max=1))

def create_shop():
    """创建店铺（带验证）"""
    schema = ShopCreateSchema()
    try:
        data = schema.load(request.get_json())
    except ValidationError as e:
        return error_response("validation_error", "请求参数验证失败", e.messages)
```

#### 前端验证
```vue
<template>
  <el-form :model="form" :rules="rules" ref="formRef">
    <el-form-item label="店铺名称" prop="name">
      <el-input v-model="form.name" />
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
const rules = {
  name: [
    { required: true, message: '请输入店铺名称', trigger: 'blur' },
    { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' },
    { pattern: /^[a-zA-Z0-9\u4e00-\u9fa5]+$/, message: '名称只能包含字母、数字和中文', trigger: 'blur' }
  ]
}
</script>
```

### 2. 数据加密

#### 密码加密
```python
from werkzeug.security import generate_password_hash, check_password_hash

class User(db.Model):
    def set_password(self, password):
        """设置密码（加密存储）"""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """验证密码"""
        return check_password_hash(self.password_hash, password)
```

#### 敏感数据加密
```python
from cryptography.fernet import Fernet
import base64

class DataEncryption:
    def __init__(self, key):
        self.cipher = Fernet(key)
    
    def encrypt(self, data: str) -> str:
        """加密数据"""
        return self.cipher.encrypt(data.encode()).decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """解密数据"""
        return self.cipher.decrypt(encrypted_data.encode()).decode()
```

### 3. SQL注入防护

#### 参数化查询
```python
# 正确做法：使用参数化查询
def get_user_by_id(user_id: int):
    return db.session.execute(
        text("SELECT * FROM users WHERE id = :user_id"),
        {"user_id": user_id}
    ).fetchone()

# 错误做法：字符串拼接（容易SQL注入）
def get_user_by_id_unsafe(user_id: int):
    return db.session.execute(
        text(f"SELECT * FROM users WHERE id = {user_id}")
    ).fetchone()
```

#### ORM查询
```python
# 使用ORM查询（自动防护SQL注入）
def get_user_by_id(user_id: int):
    return User.query.filter_by(id=user_id).first()

def get_users_by_role(role: str):
    return User.query.filter(User.role == role).all()
```

## 性能优化指南

### 1. 数据库优化

#### 查询优化
```python
# 使用JOIN减少查询次数
def get_shop_with_messages(shop_id):
    return db.session.query(Shop).options(
        db.joinedload(Shop.messages)
    ).filter(Shop.id == shop_id).first()

# 使用分页避免大量数据查询
def get_messages_paginated(page=1, per_page=20):
    return Message.query.order_by(Message.created_at.desc()).paginate(
        page=page, per_page=per_page, error_out=False
    )

# 使用索引优化查询
def get_messages_by_shop(shop_id):
    return Message.query.filter_by(shop_id=shop_id).all()
```

#### 批量操作
```python
# 批量插入
def batch_create_messages(messages_data):
    messages = [Message(**data) for data in messages_data]
    db.session.add_all(messages)
    db.session.commit()

# 批量更新
def batch_update_messages(message_ids, updates):
    Message.query.filter(Message.id.in_(message_ids)).update(updates)
    db.session.commit()
```

### 2. 缓存策略

#### 内存缓存
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_shop_config(shop_id):
    """获取店铺配置（带缓存）"""
    shop = Shop.query.get(shop_id)
    if shop and shop.config_json:
        import json
        return json.loads(shop.config_json)
    return {}
```

#### Redis缓存
```python
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cache_ai_reply(content, reply, ttl=3600):
    """缓存AI回复"""
    key = f"ai_reply:{hash(content)}"
    redis_client.setex(key, ttl, reply)

def get_cached_ai_reply(content):
    """获取缓存的AI回复"""
    key = f"ai_reply:{hash(content)}"
    return redis_client.get(key)
```

### 3. 前端优化

#### 组件懒加载
```vue
<script setup lang="ts">
import { defineAsyncComponent } from 'vue'

// 懒加载重型组件
const HeavyComponent = defineAsyncComponent(() => import('./HeavyComponent.vue'))
</script>
```

#### 图片优化
```vue
<template>
  <img 
    :src="imageSrc" 
    :alt="imageAlt"
    loading="lazy"
    @error="handleImageError"
  />
</template>
```

## 测试规范

### 1. 单元测试

#### Python测试
```python
import pytest
from app import create_app, db
from models import User, Shop

@pytest.fixture
def app():
    """测试应用"""
    app = create_app('testing')
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

def test_create_shop(client):
    """测试创建店铺"""
    response = client.post('/api/shops', json={
        'name': '测试店铺',
        'qianniu_title': '千牛-测试店铺'
    })
    assert response.status_code == 201
    assert response.json['name'] == '测试店铺'
```

#### JavaScript测试
```javascript
import { mount } from '@vue/test-utils'
import UserList from '@/components/UserList.vue'

describe('UserList', () => {
  it('renders user list correctly', () => {
    const users = [
      { id: 1, name: 'John', email: 'john@example.com' }
    ]
    
    const wrapper = mount(UserList, {
      props: { users }
    })
    
    expect(wrapper.find('.user-list').exists()).toBe(true)
    expect(wrapper.findAll('.user-item')).toHaveLength(1)
  })
})
```

### 2. 集成测试

```python
def test_user_login_flow(client):
    """测试用户登录流程"""
    # 1. 创建测试用户
    user = User(username='test', role='admin')
    user.set_password('password')
    db.session.add(user)
    db.session.commit()
    
    # 2. 登录
    response = client.post('/api/auth/login', json={
        'username': 'test',
        'password': 'password'
    })
    assert response.status_code == 200
    assert response.json['ok'] is True
    
    # 3. 访问受保护的路由
    response = client.get('/api/shops')
    assert response.status_code == 200
```

### 3. 测试覆盖率

```bash
# 运行测试并生成覆盖率报告
pytest --cov=houduan --cov-report=html

# 查看覆盖率报告
open htmlcov/index.html
```

## 总结

本开发规范涵盖了智能客服系统开发过程中的各个方面，包括：

1. **代码质量标准**: 命名规范、代码风格、函数设计
2. **注释与文档**: 文件头注释、函数注释、关键逻辑注释
3. **错误处理**: 异常捕获、日志记录、用户友好错误信息
4. **数据库设计**: 表设计原则、命名规范、索引策略
5. **API设计**: RESTful设计、响应格式、版本管理
6. **前端开发**: Vue 3组件规范、代码组织、状态管理
7. **Git规范**: 提交信息格式、分支管理、代码审查
8. **安全编码**: 输入验证、数据加密、SQL注入防护
9. **性能优化**: 数据库优化、缓存策略、前端优化
10. **测试规范**: 单元测试、集成测试、覆盖率要求

遵循这些规范可以确保代码质量、提高开发效率、降低维护成本，为项目的长期发展奠定坚实基础。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-21  
**维护人员**: 开发团队
