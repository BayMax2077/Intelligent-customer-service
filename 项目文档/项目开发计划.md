# 淘宝千牛智能客服自动回复系统

## 一、技术方案概述

### 1.1 核心架构

采用 UI 自动化 + Python 后端 + Web 管理后台 + 知识库 的四层架构：

```
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│  千牛客户端  │ ←──→ │  UI自动化层   │ ←──→ │  知识库引擎  │
│  (消息源)   │      │(消息监控/发送)│      │  (智能匹配)  │
└─────────────┘      └──────────────┘      └─────────────┘
                            ↕                      ↕
                     ┌──────────────┐      ┌─────────────┐
                     │  Python服务   │ ←──→ │ AI大模型API │
                     │  (核心逻辑)   │      │  (智能回复)  │
                     └──────────────┘      └─────────────┘
                            ↕
                     ┌──────────────┐
                     │  Web管理后台  │
                     │(审核/配置/知识库)│
                     └──────────────┘
```

### 1.2 技术选型

- UI 自动化: pyautogui + pywin32（Windows 窗口控制）
- OCR 识别: PaddleOCR 或 Tesseract（消息内容提取）
- 后端框架: Flask
- 数据库: SQLite（开发/中小规模）/ MySQL（生产）
- 向量检索: Sentence-Transformers + Faiss（知识库语义匹配）
- AI 接口: 适配器模式，支持多种大模型切换
- 前端: Vue 3 + Element Plus（管理界面）
- 调度: APScheduler（定时任务/轮询）

## 二、功能模块设计

### 2.1 用户与权限

- 角色：超级管理员、店铺管理员、客服
- 权限：
  - 超级管理员：全局配置、所有店铺
  - 店铺管理员：本店铺配置与人员
  - 客服：仅查看/审核分配消息

### 2.2 千牛消息监控

- 监控千牛工作台消息
- 提取客户消息、时间、客户 ID
- 支持多店铺窗口轮询
- 去重、状态跟踪

### 2.3 知识库管理（核心）

- 知识库类型：标准问答/商品/售后/活动
- 匹配策略：关键词、正则、语义相似度、意图识别
- 置信度：
  - >0.9：直接用知识库答案
  - 0.6-0.9：知识库答案+AI 增强
  - <0.6：直接进入 AI
- 管理：多店铺独立库、Excel/JSON 导入导出、增删改查、效果统计

### 2.4 AI 智能回复

- 多模型适配：通义千问、文心一言、智谱 GLM、OpenAI GPT 等
- Prompt 模板、对话上下文、敏感词过滤

### 2.5 混合审核

- 自动：高置信度/标准问题自动发送
- 人审：低置信度/敏感问题进入审核队列
- 审核操作：通过/修改/拒绝

### 2.6 店铺配置

- 模型选择、自动回复规则、黑白名单、营业时间、总开关

## 三、核心实现路径

### 3.1 UI 自动化实现（主要方案）

技术路线：Windows UI 自动化 + OCR

实现要点：
1) 窗口定位：pywin32 获取千牛窗口句柄；按标题识别店铺；轮询多个窗口。
2) 消息监控：
   - 截图红点/未读标记对比
   - 监听 Windows 通知
   - 定时轮询会话列表
3) 内容提取：
   - PaddleOCR 识别聊天区
   - UI 自动化复制到剪贴板，pyperclip 读取
   - 解析客户 ID/时间戳/内容
4) 消息发送：
   - 键盘输入/粘贴回复
   - 点击发送按钮
   - 回读校验发送成功

容错：失焦自动激活、OCR 重试、界面变化重定位、异常时暂停自动回复并转人工。

### 3.2 消息处理流程（含知识库）

```
1. 监控千牛窗口 → 2. 新消息 → 3. 提取消息
                               ↓
                        4. 知识库匹配
                               ↓
                ┌──────────────┬──────────────┐
                │              │              │
           置信度>0.9     0.6-0.9          <0.6
                │              │              │
          直接用知识库     知识库+AI       纯 AI
                └──────┬──────┴──────┬──────┘
                       ↓             ↓
           5. 规则检查（营业/黑白/敏感）
                       ↓
              高置信度/标准     低置信度/敏感
                       ↓             ↓
                 6. 自动发出      7. 人工审核
                          \      /
                           8. 记录日志与统计
```

### 3.3 数据库设计要点

- users：用户账号、角色、所属店铺
- shops：店铺信息、千牛账号、配置
- messages：消息记录、状态、处理方式（知识库/AI/人工）
- knowledge_base：知识条目（问题、答案、分类、店铺 ID）
- knowledge_vectors：知识条目向量索引（Faiss/Milvus）
- ai_replies：AI 回复、审核状态、采纳情况
- reply_templates：快捷话术
- audit_queue：待审核队列
- statistics：命中率、准确率等

## 四、项目结构（按 qianduan/houduan 命名）

```
智能客服/
├── houduan/                # 后端服务
│   ├── app.py              # Flask 主程序
│   ├── config.py           # 配置
│   ├── models/             # 数据模型
│   ├── services/           # 业务逻辑
│   │   ├── qianniu_monitor.py    # 千牛监控
│   │   ├── ai_adapter.py         # AI 适配器
│   │   └── message_handler.py    # 消息处理
│   ├── api/                # API 接口
│   └── utils/              # 工具函数
├── qianduan/               # 前端管理界面
│   ├── src/
│   │   ├── views/          # 页面
│   │   └── components/     # 组件
│   └── public/
├── data/                   # 数据目录
├── logs/                   # 日志
└── 项目文档/
```

## 五、开发步骤

1) 环境搭建：目录、Python 虚拟环境、基础依赖（已完成）
2) 数据库设计：表结构与迁移脚本
3) 后端核心：认证与权限、AI 适配器、消息处理引擎
4) 千牛对接：UI 自动化监控与发送
5) Web 管理后台：审核与配置界面
6) 联调测试：端到端验证与异常处理
7) 部署与运维：日志、监控、告警、备份

## 六、注意事项

- 合规：遵守淘宝平台自动回复规范
- 限流：控制外部 API 调用频率
- 安全：敏感数据加密、最小权限
- 异常：网络/超时/识别失败降级与重试
- 可扩展：模块化与适配器设计

### 当前进度（更新于 2025-10-15 晚）

- 已完成环境搭建：创建目录、Python 3.12 本地虚拟环境`.venv`、安装最小后端依赖
- 已完成数据库模型与迁移初始化：
  - 数据库：`data/sqlite.db`
  - 迁移目录：`migrations/`，已生成首版版本文件（`*_init_tables.py`）
- 已创建后端骨架：
  - `houduan/app.py`（应用工厂、扩展初始化、健康检查）
  - `houduan/config.py`（SQLite 默认配置，支持`DATABASE_URL`）
  - `houduan/models/__init__.py`（核心表：users/shops/messages/knowledge_* 等）
 - 已完成最小API：认证与店铺（`/api/auth/*`, `/api/shops`）
 - 已完成后端测试（pytest）：用例在`tests/test_api.py`通过（登录 + 店铺 CRUD）
 - UI 自动化原型与端到端探针：
   - 列窗/发送：`GET /api/qianniu/windows`、`POST /api/qianniu/send_test`
   - 未读检测：`POST /api/qianniu/unread_probe`（score=0-1）
   - OCR入库：`POST /api/qianniu/ocr_capture`（写入`messages`表）
   - 消息查询：`GET /api/messages`
 - 消息处理流水线（骨架）：
   - 处理接口：`POST /api/messages/process`（知识库优先→AI建议→审核队列）
   - 服务文件：`services/knowledge_base.py`、`services/ai_adapter.py`、`services/message_handler.py`
 - 知识库检索：
   - 向量优先、Jaccard回退：`services/vector_search.py`
   - 检索接口：`POST /api/kb/search`
- 店铺配置与后台轮询（已接入）：
    - 店铺配置：`GET/PUT /api/shops/{id}/config`（`ocr_region`、`unread_threshold`、`title_kw`、`auto_mode`）
    - 轮询任务：APScheduler 每 10s 执行一次未读检测→OCR→入库
 - AI 模型接入（OpenAI 可选）：
   - 适配器：`services/ai_adapter.py`（`OPENAI_API_KEY`、`OPENAI_MODEL`）
   - 店铺级选择：`ai_model`（openai/stub）
- 审核与发送（半自动闭环）：
   - 审核接口：`GET /api/audit`、`POST /api/audit/approve|reject`
   - 发送实现：UI 自动化聚焦千牛并输入文本回车
- 前端错误呈现：新增登录失败详细弹窗，便于排查接口/跨域/后台错误。
- 运行端口规范：Vite 预览推荐 5174 严格端口；后端固定 5002。
- 调度器稳健性：后台任务统一在应用上下文内访问数据库，异常降级为 warning，不影响主线程接口。
- 更多详情见：`项目文档/功能清单.md` 与 `项目文档/测试日志.md`。

## To-dos（详见功能清单与测试日志）

- [x] 创建项目目录结构、配置 Python 虚拟环境、安装基础依赖
- [x] 设计并实现数据库模型（用户、店铺、消息、权限等表）
- [x] 实现用户认证和多角色权限管理系统
- [x] 开发知识库模块（向量检索、语义匹配、置信度）
- [ ] 开发 AI 模型适配器（通义/文心/GLM/OpenAI 等）
- [x] 实现千牛消息监控模块（UI 自动化）
- [x] 开发消息处理引擎与混合审核流程
- [x] 实现 Flask 后端 API（店铺、审核、配置）
- [x] 编写并运行后端最小API测试用例（认证与店铺CRUD）
- [ ] 开发 Web 管理后台（Vue 3 + Element Plus）
- [ ] 联调测试与异常处理优化

### 已知风险与规避
- 后台调度器越权访问数据库导致 SQLAlchemy 上下文错误：已通过 app_context 包裹与启动顺序调整规避。
- 端口冲突与跨域：统一端口策略（5174/5002）+ CORS 白名单集合。