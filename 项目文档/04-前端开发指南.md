# 智能客服系统前端开发指南

## 概述

智能客服系统前端采用Vue 3 + Element Plus + Vite技术栈，提供现代化的管理界面，支持店铺配置、消息管理、审核队列、知识库管理等核心功能。

## 技术栈

### 核心框架
- **Vue 3.5+**: 组合式API，性能优化
- **Vite 5.4+**: 快速构建工具，热更新
- **TypeScript**: 类型安全，开发体验

### UI组件库
- **Element Plus 2.8+**: 企业级UI组件库
- **@element-plus/icons-vue**: 图标组件

### 状态管理
- **Pinia 2.2+**: Vue 3官方推荐的状态管理
- **Vue Router 4.4+**: 官方路由解决方案

### HTTP客户端
- **Axios 1.7+**: HTTP请求库
- **ECharts 6.0+**: 图表可视化

## 项目结构

```
qianduan/src/
├── main.ts                 # 应用入口
├── App.vue                 # 根组件
├── router.ts              # 路由配置
├── api/                   # API客户端
│   └── http.ts            # HTTP配置
├── store/                  # 状态管理
│   └── auth.ts            # 认证状态
├── views/                 # 页面组件
│   ├── Login.vue          # 登录页
│   ├── Shops.vue          # 店铺管理
│   ├── Messages.vue       # 消息管理
│   ├── Audit.vue          # 审核队列
│   ├── KnowledgeBase.vue  # 知识库管理
│   ├── Statistics.vue     # 统计报表
│   └── Users.vue          # 用户管理
├── components/            # 通用组件
└── styles/                # 样式文件
    └── global.css         # 全局样式
```

## 开发环境配置

### 环境要求
- **Node.js**: 18+ (推荐LTS版本)
- **npm**: 9+ 或 **yarn**: 1.22+
- **操作系统**: Windows 10/11, macOS, Linux

### 安装依赖
```bash
cd qianduan
npm install
```

### 开发服务器
```bash
npm run dev
# 访问: http://localhost:5174
```

### 构建生产版本
```bash
npm run build
# 输出目录: dist/
```

### 预览生产版本
```bash
npm run preview
# 访问: http://localhost:5174
```

## 核心组件开发

### 1. 应用入口 (main.ts)

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'

import App from './App.vue'
import router from './router'
import './styles/global.css'

const app = createApp(App)

// 注册Element Plus图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}

app.use(createPinia())
app.use(router)
app.use(ElementPlus)

app.mount('#app')
```

### 2. 路由配置 (router.ts)

```typescript
import { createRouter, createWebHistory } from 'vue-router'
import { useAuthStore } from './store/auth'

const routes = [
  {
    path: '/',
    redirect: '/shops'
  },
  {
    path: '/login',
    name: 'Login',
    component: () => import('./views/Login.vue'),
    meta: { requiresAuth: false }
  },
  {
    path: '/shops',
    name: 'Shops',
    component: () => import('./views/Shops.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/messages',
    name: 'Messages',
    component: () => import('./views/Messages.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/audit',
    name: 'Audit',
    component: () => import('./views/Audit.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/knowledge-base',
    name: 'KnowledgeBase',
    component: () => import('./views/KnowledgeBase.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/statistics',
    name: 'Statistics',
    component: () => import('./views/Statistics.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/users',
    name: 'Users',
    component: () => import('./views/Users.vue'),
    meta: { requiresAuth: true }
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// 路由守卫
router.beforeEach((to, from, next) => {
  const auth = useAuthStore()
  
  if (to.meta.requiresAuth && !auth.isAuthed) {
    next('/login')
  } else if (to.path === '/login' && auth.isAuthed) {
    next('/shops')
  } else {
    next()
  }
})

export default router
```

### 3. HTTP客户端 (api/http.ts)

```typescript
import axios from 'axios'

const http = axios.create({
  baseURL: import.meta.env.VITE_API_BASE || 'http://localhost:5002',
  timeout: 10000,
  withCredentials: true, // 支持Cookie认证
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
http.interceptors.request.use(
  (config) => {
    // 可以在这里添加认证token
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
http.interceptors.response.use(
  (response) => {
    return response
  },
  (error) => {
    // 统一错误处理
    if (error.response?.status === 401) {
      // 未授权，跳转到登录页
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)

export default http
```

### 4. 状态管理 (store/auth.ts)

```typescript
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useAuthStore = defineStore('auth', () => {
  const isAuthed = ref(false)
  const username = ref('')
  const role = ref('')

  const setAuthed = (authed: boolean, user?: string, userRole?: string) => {
    isAuthed.value = authed
    if (user) username.value = user
    if (userRole) role.value = userRole
  }

  const logout = () => {
    isAuthed.value = false
    username.value = ''
    role.value = ''
  }

  return {
    isAuthed,
    username,
    role,
    setAuthed,
    logout
  }
})
```

## 页面组件开发

### 1. 登录页面 (Login.vue)

```vue
<template>
  <div class="login-page">
    <div class="login-title">智能客服管理台</div>
    <div class="section-card login-card">
      <p class="desc">使用管理员账号登录以管理店铺配置与审核队列。</p>
      <el-form class="login-form" label-position="top" @submit.prevent="onLogin">
        <el-form-item label="用户名">
          <el-input v-model="username" @keyup.enter="onLogin" />
        </el-form-item>
        <el-form-item label="密码">
          <el-input v-model="password" type="password" @keyup.enter="onLogin" />
        </el-form-item>
        <el-button type="primary" @click="onLogin" :loading="loading" class="login-btn">
          登录
        </el-button>
      </el-form>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import http from '../api/http'
import { useAuthStore } from '../store/auth'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useRouter } from 'vue-router'

const username = ref('admin')
const password = ref('admin')
const loading = ref(false)
const router = useRouter()
const auth = useAuthStore()

const onLogin = async () => {
  if (!username.value || !password.value) {
    ElMessage.error('请输入用户名和密码')
    return
  }
  
  loading.value = true
  try {
    const res = await http.post('/api/auth/login', { 
      username: username.value, 
      password: password.value 
    })
    
    if (res.data?.ok) {
      auth.setAuthed(true, username.value)
      router.push('/shops')
    } else {
      ElMessage.error('登录失败')
    }
  } catch (e: any) {
    // 详细的错误处理
    const status = e?.response?.status
    const data = e?.response?.data
    const isNetwork = e?.message?.includes('Network')
    
    let errorMessage = data?.error || e?.message || '登录失败'
    if (isNetwork) {
      errorMessage += ' - 网络或跨域被浏览器拦截'
    }
    
    ElMessage.error(errorMessage)
    
    // 显示详细错误信息
    if (e?.response) {
      await ElMessageBox.alert(
        `请求URL: ${e.config?.url}\n状态码: ${status}\n错误信息: ${JSON.stringify(data, null, 2)}`,
        '登录失败 - 详细信息',
        { confirmButtonText: '我知道了' }
      )
    }
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.login-page {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 16px;
}

.login-title {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 18px;
  color: #303133;
}

.login-card {
  width: 460px;
  height: 460px;
  max-width: 92vw;
  max-height: 92vh;
  padding: 28px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.login-form {
  width: 100%;
}

.login-btn {
  width: 100%;
  height: 44px;
  font-size: 16px;
}
</style>
```

### 2. 店铺管理页面 (Shops.vue)

```vue
<template>
  <div class="shops-page">
    <!-- 页面头部 -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="title">
            <el-icon><Shop /></el-icon>
            店铺配置
          </h1>
          <p class="subtitle">管理千牛监控与AI参数，配置OCR区域和未读阈值</p>
        </div>
        <div class="header-actions">
          <el-button @click="load" :loading="loading">
            <el-icon><Refresh /></el-icon>
            刷新数据
          </el-button>
          <el-button type="primary" @click="addNewShop">
            <el-icon><Plus /></el-icon>
            新增店铺配置
          </el-button>
        </div>
      </div>
    </div>

    <!-- 店铺列表 -->
    <el-table :data="shops" v-loading="loading" empty-text="暂无店铺配置">
      <el-table-column prop="id" label="ID" width="80" align="center" />
      <el-table-column prop="name" label="店铺名称" min-width="150">
        <template #default="{ row }">
          <div class="shop-name">
            <el-icon><Shop /></el-icon>
            <span>{{ row.name }}</span>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="qianniu_title" label="千牛标题" min-width="200" />
      <el-table-column label="OCR区域" width="120" align="center">
        <template #default="{ row }">
          <el-tag size="small" v-if="row.ocr_region">
            {{ row.ocr_region.join(', ') }}
          </el-tag>
          <el-tag size="small" type="info" v-else>未配置</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="150" align="center">
        <template #default="{ row }">
          <el-button size="small" @click="editShop(row)">编辑</el-button>
          <el-button size="small" type="danger" @click="deleteShop(row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 新增/编辑对话框 -->
    <el-dialog
      v-model="showAddDialog"
      :title="editingShop ? '编辑店铺配置' : '新增店铺配置'"
      width="800px"
    >
      <el-form :model="formData" label-width="120px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="店铺名称" required>
              <el-input v-model="formData.name" placeholder="请输入店铺名称" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="千牛标题" required>
              <el-input v-model="formData.qianniu_title" placeholder="请输入千牛窗口标题" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="OCR区域" required>
          <el-input v-model="formData.ocr_region_text" placeholder="格式: x,y,w,h" />
          <div class="form-tip">建议覆盖聊天区域，格式为：左上角x,左上角y,宽度,高度</div>
        </el-form-item>

        <el-form-item label="未读阈值" required>
          <el-input-number v-model="formData.unread_threshold" :min="0" :max="1" :step="0.01" :precision="2" />
          <div class="form-tip">检测到红点比例≥阈值视为有未读，建议0.02~0.06</div>
        </el-form-item>

        <el-form-item label="AI模型">
          <el-select v-model="formData.ai_model" style="width: 100%;">
            <el-option label="占位(stub)" value="stub" />
            <el-option label="通义千问(qwen)" value="qwen" />
            <el-option label="文心一言(ernie)" value="ernie" />
            <el-option label="OpenAI(openai)" value="openai" />
          </el-select>
        </el-form-item>

        <el-form-item label="自动模式">
          <el-switch v-model="formData.auto_mode" />
          <div class="form-tip">开启后高置信度将直接发送</div>
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="showAddDialog = false">取消</el-button>
        <el-button type="primary" @click="saveShop" :loading="saving">
          {{ editingShop ? '更新' : '保存' }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import http from '../api/http'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Shop, Refresh, Plus } from '@element-plus/icons-vue'

const shops = ref<any[]>([])
const loading = ref(false)
const saving = ref(false)
const showAddDialog = ref(false)
const editingShop = ref<any>(null)

const formData = reactive({
  name: '',
  qianniu_title: '',
  ocr_region_text: '800,200,600,300',
  unread_threshold: 0.02,
  ai_model: 'stub',
  auto_mode: false
})

const load = async () => {
  loading.value = true
  try {
    const res = await http.get('/api/shops')
    shops.value = res.data
  } catch (error: any) {
    console.error('加载店铺列表失败:', error)
    ElMessage.error('加载店铺列表失败')
  } finally {
    loading.value = false
  }
}

const addNewShop = () => {
  editingShop.value = null
  resetForm()
  showAddDialog.value = true
}

const editShop = (shop: any) => {
  editingShop.value = shop
  formData.name = shop.name
  formData.qianniu_title = shop.qianniu_title
  formData.ocr_region_text = shop.ocr_region ? shop.ocr_region.join(',') : '800,200,600,300'
  formData.unread_threshold = shop.unread_threshold || 0.02
  formData.ai_model = shop.ai_model || 'stub'
  formData.auto_mode = shop.auto_mode || false
  showAddDialog.value = true
}

const deleteShop = async (shop: any) => {
  try {
    await ElMessageBox.confirm(
      `确定要删除店铺"${shop.name}"吗？\n\n⚠️ 警告：删除店铺将同时删除以下关联数据：\n• 该店铺的所有消息记录\n• 该店铺的知识库条目\n• 该店铺的回复模板\n• 该店铺用户的店铺关联将被清除\n\n此操作不可恢复，请谨慎操作！`,
      '确认删除店铺',
      {
        confirmButtonText: '确认删除',
        cancelButtonText: '取消',
        type: 'warning',
        dangerouslyUseHTMLString: true
      }
    )
    
    await http.delete(`/api/shops/${shop.id}`)
    ElMessage.success('店铺删除成功')
    load()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('删除失败')
    }
  }
}

const saveShop = async () => {
  if (!formData.name.trim() || !formData.qianniu_title.trim()) {
    ElMessage.warning('请填写店铺名称和千牛标题')
    return
  }

  saving.value = true
  try {
    const arr = formData.ocr_region_text.split(',').map(x => parseInt(x.trim(), 10)).filter(x => !Number.isNaN(x))
    
    const data = {
      name: formData.name,
      qianniu_title: formData.qianniu_title,
      ocr_region: arr,
      unread_threshold: formData.unread_threshold,
      ai_model: formData.ai_model,
      auto_mode: formData.auto_mode
    }

    if (editingShop.value) {
      await http.put(`/api/shops/${editingShop.value.id}`, data)
      ElMessage.success('店铺更新成功')
    } else {
      await http.post('/api/shops', data)
      ElMessage.success('店铺创建成功')
    }
    
    showAddDialog.value = false
    resetForm()
    load()
  } catch (error: any) {
    console.error('保存店铺失败:', error)
    ElMessage.error('保存失败')
  } finally {
    saving.value = false
  }
}

const resetForm = () => {
  editingShop.value = null
  formData.name = ''
  formData.qianniu_title = ''
  formData.ocr_region_text = '800,200,600,300'
  formData.unread_threshold = 0.02
  formData.ai_model = 'stub'
  formData.auto_mode = false
}

// 初始化
load()
</script>

<style scoped>
.shops-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0;
}

.page-header {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: var(--space-lg);
  border: 1px solid var(--border-light);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: var(--space-lg);
  gap: var(--space-lg);
}

.title {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  font-size: 24px;
  font-weight: 700;
  margin: 0 0 var(--space-sm);
  color: var(--text-primary);
}

.shop-name {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
  font-weight: 500;
}

.form-tip {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: var(--space-xs);
  line-height: 1.4;
}
</style>
```

## 开发规范

### 1. 组件命名规范

- **组件文件**: 使用PascalCase，如 `UserList.vue`
- **组件注册**: 使用kebab-case，如 `<user-list>`
- **Props**: 使用camelCase，如 `userName`
- **Events**: 使用kebab-case，如 `@user-updated`

### 2. 代码组织规范

```vue
<template>
  <!-- 模板内容 -->
</template>

<script setup lang="ts">
// 1. 导入
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'

// 2. 类型定义
interface User {
  id: number
  name: string
  email: string
}

// 3. 响应式数据
const loading = ref(false)
const users = ref<User[]>([])

// 4. 计算属性
const filteredUsers = computed(() => {
  return users.value.filter(user => user.active)
})

// 5. 方法
const loadUsers = async () => {
  loading.value = true
  try {
    // API调用
  } finally {
    loading.value = false
  }
}

// 6. 生命周期
onMounted(() => {
  loadUsers()
})
</script>

<style scoped>
/* 组件样式 */
</style>
```

### 3. 样式规范

#### CSS变量使用
```css
:root {
  --primary-color: #409eff;
  --success-color: #67c23a;
  --warning-color: #e6a23c;
  --danger-color: #f56c6c;
  --info-color: #909399;
  
  --text-primary: #303133;
  --text-regular: #606266;
  --text-secondary: #909399;
  --text-placeholder: #c0c4cc;
  
  --border-base: #dcdfe6;
  --border-light: #e4e7ed;
  --border-lighter: #ebeef5;
  --border-extra-light: #f2f6fc;
  
  --bg-color: #ffffff;
  --bg-page: #f2f3f5;
  
  --space-xs: 4px;
  --space-sm: 8px;
  --space-md: 16px;
  --space-lg: 24px;
  --space-xl: 32px;
  
  --radius: 4px;
  --shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
}
```

#### 响应式设计
```css
/* 移动端适配 */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: stretch;
  }
  
  .header-actions {
    justify-content: stretch;
  }
  
  .header-actions .el-button {
    flex: 1;
  }
}
```

### 4. 错误处理规范

```typescript
// API调用错误处理
const handleApiError = (error: any, operation: string) => {
  console.error(`${operation}失败:`, error)
  
  if (error.response) {
    // 服务器返回了错误响应
    const status = error.response.status
    const data = error.response.data
    
    switch (status) {
      case 400:
        ElMessage.error(`${operation}失败：请求参数错误`)
        break
      case 401:
        ElMessage.error(`${operation}失败：请先登录`)
        break
      case 403:
        ElMessage.error(`${operation}失败：权限不足`)
        break
      case 500:
        ElMessage.error(`${operation}失败：服务器内部错误`)
        break
      default:
        ElMessage.error(`${operation}失败：服务器错误 (${status})`)
    }
  } else if (error.request) {
    // 请求发送了但没有收到响应
    ElMessage.error(`${operation}失败：网络连接失败`)
  } else {
    // 其他错误
    ElMessage.error(`${operation}失败：${error.message || '未知错误'}`)
  }
}
```

### 5. 表单验证规范

```typescript
// 表单验证规则
const rules = {
  name: [
    { required: true, message: '请输入店铺名称', trigger: 'blur' },
    { min: 2, max: 50, message: '长度在 2 到 50 个字符', trigger: 'blur' }
  ],
  email: [
    { required: true, message: '请输入邮箱地址', trigger: 'blur' },
    { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }
  ]
}

// 表单验证
const validateForm = () => {
  if (!formData.name.trim()) {
    ElMessage.warning('请输入店铺名称')
    return false
  }
  
  if (!formData.qianniu_title.trim()) {
    ElMessage.warning('请输入千牛标题')
    return false
  }
  
  return true
}
```

## 构建与部署

### 1. 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 访问: http://localhost:5174
```

### 2. 生产构建
```bash
# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

### 3. 环境变量配置

#### 开发环境 (.env.development)
```bash
VITE_API_BASE=http://localhost:5002
VITE_APP_TITLE=智能客服系统
```

#### 生产环境 (.env.production)
```bash
VITE_API_BASE=http://your-server-ip:5002
VITE_APP_TITLE=智能客服系统
```

### 4. 部署配置

#### Nginx配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /path/to/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 性能优化

### 1. 代码分割
```typescript
// 路由懒加载
const routes = [
  {
    path: '/shops',
    component: () => import('./views/Shops.vue')
  }
]
```

### 2. 组件懒加载
```vue
<script setup lang="ts">
import { defineAsyncComponent } from 'vue'

const HeavyComponent = defineAsyncComponent(() => import('./HeavyComponent.vue'))
</script>
```

### 3. 图片优化
```vue
<template>
  <img 
    :src="imageSrc" 
    :alt="imageAlt"
    loading="lazy"
    @error="handleImageError"
  />
</template>
```

### 4. 缓存策略
```typescript
// HTTP缓存配置
const http = axios.create({
  baseURL: import.meta.env.VITE_API_BASE,
  timeout: 10000,
  withCredentials: true,
  headers: {
    'Cache-Control': 'no-cache'
  }
})
```

## 调试技巧

### 1. Vue DevTools
- 安装Vue DevTools浏览器扩展
- 查看组件状态和Props
- 监控Vuex/Pinia状态变化

### 2. 网络调试
```typescript
// 请求日志
http.interceptors.request.use(config => {
  console.log('请求:', config.method?.toUpperCase(), config.url)
  return config
})

http.interceptors.response.use(response => {
  console.log('响应:', response.status, response.data)
  return response
})
```

### 3. 错误边界
```vue
<template>
  <div v-if="error" class="error-boundary">
    <h3>出现错误</h3>
    <p>{{ error.message }}</p>
    <el-button @click="retry">重试</el-button>
  </div>
  <div v-else>
    <!-- 正常内容 -->
  </div>
</template>

<script setup lang="ts">
import { ref, onErrorCaptured } from 'vue'

const error = ref<Error | null>(null)

onErrorCaptured((err) => {
  error.value = err
  console.error('组件错误:', err)
  return false
})

const retry = () => {
  error.value = null
  // 重新加载数据
}
</script>
```

## 最佳实践

### 1. 组件设计
- 单一职责：每个组件只负责一个功能
- 可复用性：设计通用的可复用组件
- 可维护性：保持代码简洁，添加适当注释

### 2. 状态管理
- 合理使用Pinia管理全局状态
- 避免过度使用状态管理
- 保持状态结构扁平化

### 3. 性能考虑
- 使用v-show和v-if合理切换
- 避免在模板中使用复杂计算
- 合理使用key属性优化列表渲染

### 4. 用户体验
- 提供加载状态反馈
- 处理错误情况
- 响应式设计适配不同设备

---

**文档版本**: v1.0  
**最后更新**: 2025-01-21  
**维护人员**: 前端团队
